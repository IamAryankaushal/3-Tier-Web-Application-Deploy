name: CI - WordPress 3 Tier App

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  IMAGE_NAME: custom-wordpress
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-and-validate:
    name: Build & Validate Manifests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Build WordPress Docker image
        run: |
          docker build \
            -t $IMAGE_NAME:$IMAGE_TAG \
            .

      #  Kubernetes YAML validation WITHOUT cluster
      - name: Validate Kubernetes manifests (client-side)
        run: |
          kubectl apply \
            --dry-run=client \
            -f k8s/ \
            --validate=false

  minikube-smoke-test:
    name: Minikube Smoke Test (Ephemeral)
    runs-on: ubuntu-latest
    needs: build-and-validate

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: v1.29.0

      - name: Install Minikube
        run: |
          curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
          sudo install minikube-linux-amd64 /usr/local/bin/minikube

      - name: Start Minikube
        run: |
          minikube start --driver=docker
          minikube status

      - name: Use Minikube Docker daemon
        run: |
          eval $(minikube docker-env)

      - name: Build image inside Minikube
        run: |
          docker build \
            -t $IMAGE_NAME:test \
            ./docker/wordpress

      - name: Deploy Kubernetes manifests
        run: |
          kubectl apply -f k8s/

      - name: Wait for WordPress deployment
        run: |
          kubectl rollout status deployment/wordpress -n wordpress --timeout=180s

      - name: Get pod status (debug)
        run: |
          kubectl get pods -n wordpress -o wide
