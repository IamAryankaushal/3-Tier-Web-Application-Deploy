name: CI - WordPress 3 Tier App

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  IMAGE_NAME: custom-wordpress
  IMAGE_TAG: test

jobs:
  build-and-validate:
    name: Build & Validate Manifests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: v1.29.0

      - name: Build WordPress Docker image
        run: |
          docker build \
            -t $IMAGE_NAME:$IMAGE_TAG \
            .

      - name: Validate Kubernetes manifests (offline)
        run: |
          # Install kubeconform for offline validation
          curl -L https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz | tar xz
          sudo mv kubeconform /usr/local/bin/
          
          # Validate all manifests
          kubeconform -summary k8s/

  minikube-smoke-test:
    name: Minikube Smoke Test (Ephemeral)
    runs-on: ubuntu-latest
    needs: build-and-validate

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: v1.29.0

      - name: Install Minikube
        run: |
          curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
          sudo install minikube-linux-amd64 /usr/local/bin/minikube

      - name: Start Minikube
        run: |
          minikube start --driver=docker --wait=all
          minikube status

      - name: Build image inside Minikube
        run: |
          # Point shell to minikube's docker daemon and build
          eval $(minikube -p minikube docker-env)
          docker build -t $IMAGE_NAME:$IMAGE_TAG .
          # Verify image was built
          docker images | grep $IMAGE_NAME

      - name: Update manifests to use local image
        run: |
          # Update WordPress deployment to use imagePullPolicy: Never
          sed -i 's|imagePullPolicy:.*|imagePullPolicy: Never|g' k8s/wordpress/deployment.yaml
          # Ensure image name matches
          sed -i "s|image:.*custom-wordpress.*|image: $IMAGE_NAME:$IMAGE_TAG|g" k8s/wordpress/deployment.yaml

      - name: Deploy Kubernetes manifests
        run: |
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/mysql/pvc.yaml
          kubectl apply -f k8s/mysql/statefulset.yaml
          kubectl apply -f k8s/mysql/service.yaml
          kubectl apply -f k8s/wordpress/pvc.yaml
          kubectl apply -f k8s/wordpress/deployment.yaml
          kubectl apply -f k8s/wordpress/service.yaml

      - name: Wait for MySQL to be ready
        run: |
          kubectl wait --for=condition=ready pod -l app=mysql -n wordpress --timeout=180s

      - name: Wait for WordPress deployment
        run: |
          kubectl rollout status deployment/wordpress -n wordpress --timeout=300s

      - name: Get pod status (debug)
        run: |
          kubectl get pods -n wordpress -o wide
          kubectl describe pods -n wordpress

      - name: Check WordPress pod logs (if failed)
        if: failure()
        run: |
          kubectl logs -l app=wordpress -n wordpress --tail=50 || true